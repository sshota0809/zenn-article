---
title: "GCP の Cloud Load Balancing でマネージド証明書への切り替えを無停止で行う方法"
emoji: "🍀"
type: "tech" #
topics: ["GCP", "GCLB", "CloudLoadBalancing"]
published: false
---

# 概要

こんにちは、[@sshota0809](https://twitter.com/sshota0809) です。

最近、[Hybrid connectivity NEG を利用した、ハイブリッド/マルチクラウドでの負荷分散機能がサポートされたり](https://medium.com/google-cloud-jp/hybrid-load-balancing-27e77a4ec62) 、フロントのロードバランサをオンプレ環境から GCP の Cloud Load Balancing（GCLB）に移行するケースなどがより増えてくるのではないかと考えております。

せっかく、パブリッククラウドにロードバランサを移行するのであれば証明書管理からも解放されるべく、マネージド証明書も使いたいですよね。

しかし、既存の FQDN を無停止でマネージド証明書をアタッチした GCLB に移行するには、実はひと工夫必要になります。

今回は、どのようにそれを実現するか紹介します。

# TL;DR

* GCP のマネージド証明書は GCLB にアタッチした上で[対象の FQDN の DNS レコードを GCLB の IP に切り替えないと有効化されない](https://cloud.google.com/load-balancing/docs/ssl-certificates/troubleshooting#domain-status)
* DNS レコード設定〜マネージド証明書が有効化されるまで一定時間がかかるため、その時間証明書が利用できずその間ダウンタイムが発生してしまう
* 一方、[GCLB には複数の証明書をアタッチできる](https://cloud.google.com/load-balancing/docs/ssl-certificates#multiplessl) ため、同じ CN/SAN を持つセルフマネージド証明書とマネージド証明書をアタッチすることでダウンタイム無しで切り替えが可能
  * マネージド証明書が有効化されるまではセルフマネージド証明書が内部では利用される
  * マネージド証明書が有効化された後、セルフマネージド証明書をデタッチすることで以降マネージド証明書が利用される

# GCP のマネージド証明書のアクティベート

GCP のマネージド証明書にはマネージドステータスとドメインステータスという概念があり、マネージド証明書の CN/SAN の DNS レコードがその証明書がアタッチされている IP アドレスで解決されないと `ACTIVE` ステータスにならず利用できません。

* 参考: [ドメインステータス](https://cloud.google.com/load-balancing/docs/ssl-certificates/troubleshooting#domain-status)

> **FAILED_NOT_VISIBLE**
> 
> ドメインの証明書のプロビジョニングが完了していません。次のいずれかが問題である可能性があります。
> ドメインの DNS レコードが、Google Cloud ロードバランサの IP アドレスに解決されません。この問題を解決するには、DNS の A レコードと AAAA レコードを更新して、ロードバランサの IP アドレスを指定します。
> DNS は、ロードバランサの IP アドレス以外の IP アドレスに解決されないようにする必要があります。たとえば、A レコードが正しいロードバランサに解決され、AAAA は別のロードバランサに解決される場合、ドメインのステータスは FAILED_NOT_VISIBLE になります。
> 
> 更新された DNS A レコードと AAAA レコードが完全に伝播されるまで、かなり時間がかかることがあります。通常は数時間程度ですが、インターネットを介した反映には最長で 72 時間かかることもあります。ドメイン ステータスは、伝播が完了するまで FAILED_NOT_VISIBLE になります。
> 
> SSL 証明書がロードバランサのターゲット プロキシに適用されていません。この問題を解決するには、ロードバランサの構成を更新してください。
> 
> グローバル転送ルール用のフロントエンド ポートに、SSL プロキシ ロードバランサ用のポート 443 が含まれていません。この問題は、ポート 443 を使用して新しい転送ルールを追加すると解決できます。
> 
> マネージド ステータスが PROVISIONING の場合、ドメイン ステータスが FAILED_NOT_VISIBLE であっても、Google Cloud はプロビジョニングを再試行します。

新しくシステムとしてサービスインする FQDN であれば DNS レコードを登録してアクティベートされるのを待てばよいですが、既にサービスイン済みの DNS レコードの切り替えを行ってしまうとマネージド証明書がアクティベートされるまでサービスは停止してしまいます。だからといって DNS レコードを切り替えないと永遠とマネージド証明書はアクティベートされないので、このままではダウンタイムは避けられません。

## GCLB に複数の証明書をアタッチする

# 終わりに

